---
metadata:
  name: "Hook Security Rules"
  description: "Security rules for hook configurations and behaviors"
  version: "1.0.0"
  author: "Security Team"
  category: "hooks"

rules:
  # Dangerous hook events
  - id: "hook-pre-message"
    name: "Pre-Message Hook"
    description: "Hook intercepts messages before processing"
    severity: "high"
    category: "hook-events"
    pattern: "\"(on_message|pre_message|before_message|message_handler)\""
    pattern_flags: ["IGNORECASE"]
    recommendation: "Review pre-message hooks for data interception risks"
    tags: ["hooks", "interception"]

  - id: "hook-pre-response"
    name: "Pre-Response Hook"
    description: "Hook intercepts responses before delivery"
    severity: "high"
    category: "hook-events"
    pattern: "\"(on_response|pre_response|before_response|response_handler)\""
    pattern_flags: ["IGNORECASE"]
    recommendation: "Review pre-response hooks for tampering risks"
    tags: ["hooks", "interception"]

  - id: "hook-tool-call"
    name: "Tool Call Hook"
    description: "Hook intercepts tool calls"
    severity: "high"
    category: "hook-events"
    pattern: "\"(on_tool|pre_tool|before_tool|tool_handler)\""
    pattern_flags: ["IGNORECASE"]
    recommendation: "Review tool call hooks for manipulation risks"
    tags: ["hooks", "tools"]

  - id: "hook-file-access"
    name: "File Access Hook"
    description: "Hook monitors file access operations"
    severity: "medium"
    category: "hook-events"
    pattern: "\"(on_file|file_access|file_read|file_write)\""
    pattern_flags: ["IGNORECASE"]
    recommendation: "Review file access hooks for data exfiltration"
    tags: ["hooks", "filesystem"]

  - id: "hook-network"
    name: "Network Hook"
    description: "Hook monitors network operations"
    severity: "medium"
    category: "hook-events"
    pattern: "\"(on_network|network_access|http_request|api_call)\""
    pattern_flags: ["IGNORECASE"]
    recommendation: "Review network hooks for data exfiltration"
    tags: ["hooks", "network"]

  # Hook behavior risks
  - id: "hook-modifies-input"
    name: "Hook Modifies Input"
    description: "Hook explicitly modifies input data via method call"
    severity: "high"
    category: "hook-behavior"
    pattern: "\\.(modify|mutate|replace|transform)\\s*\\(.*input"
    pattern_flags: ["IGNORECASE"]
    recommendation: "Review input modification logic for security"
    tags: ["hooks", "tampering"]

  - id: "hook-modifies-output"
    name: "Hook Modifies Output"
    description: "Hook explicitly modifies output data via method call"
    severity: "high"
    category: "hook-behavior"
    pattern: "\\.(modify|mutate|replace|transform)\\s*\\(.*output"
    pattern_flags: ["IGNORECASE"]
    recommendation: "Review output modification logic for security"
    tags: ["hooks", "tampering"]

  - id: "hook-logs-content"
    name: "Hook Logs Content"
    description: "Hook logs sensitive content such as user input, request bodies, or message content"
    severity: "medium"
    category: "hook-behavior"
    pattern: "log\\w*\\s*\\(.*(?:user_input|request\\.body|message\\.content|user_message|prompt_text)"
    pattern_flags: ["IGNORECASE"]
    recommendation: "Ensure logged content doesn't include sensitive data"
    tags: ["hooks", "logging", "privacy"]

  - id: "hook-external-call"
    name: "Hook Makes External Call"
    description: "Hook makes external HTTP/network calls"
    severity: "high"
    category: "hook-behavior"
    pattern: "(fetch|axios|http|request)\\s*\\(|XMLHttpRequest"
    pattern_flags: ["IGNORECASE"]
    recommendation: "Review external calls for data exfiltration"
    tags: ["hooks", "network", "exfiltration"]

  - id: "hook-sends-data"
    name: "Hook Sends Data Externally"
    description: "Hook appears to send data to external endpoint"
    severity: "critical"
    category: "hook-behavior"
    pattern: "(send|post|transmit|upload).*https?://"
    pattern_flags: ["IGNORECASE"]
    recommendation: "Review data transmission for unauthorized exfiltration"
    tags: ["hooks", "exfiltration"]

  # Hook execution risks
  - id: "hook-eval"
    name: "Hook Uses Eval"
    description: "Hook uses eval for dynamic code execution"
    severity: "critical"
    category: "hook-execution"
    pattern: "eval\\s*\\("
    pattern_flags: []
    recommendation: "Never use eval in hooks"
    tags: ["hooks", "code-execution"]

  - id: "hook-function-constructor"
    name: "Hook Uses Function Constructor"
    description: "Hook uses Function constructor for code execution"
    severity: "critical"
    category: "hook-execution"
    pattern: "new\\s+Function\\s*\\("
    pattern_flags: []
    recommendation: "Avoid Function constructor in hooks"
    tags: ["hooks", "code-execution"]

  - id: "hook-shell-exec"
    name: "Hook Executes Shell Commands"
    description: "Hook executes shell commands"
    severity: "critical"
    category: "hook-execution"
    pattern: "(exec|spawn|execSync|spawnSync)\\s*\\(|child_process"
    pattern_flags: []
    recommendation: "Avoid shell execution in hooks"
    tags: ["hooks", "shell", "code-execution"]

  # Configuration risks
  - id: "hook-no-validation"
    name: "Hook Without Input Validation"
    description: "Hook processes input without validation"
    severity: "medium"
    category: "hook-config"
    pattern: "\"validate\"\\s*:\\s*false|\"skip_validation\"\\s*:\\s*true"
    pattern_flags: ["IGNORECASE"]
    recommendation: "Enable input validation for hooks"
    tags: ["hooks", "validation"]

  - id: "hook-async-unhandled"
    name: "Async Hook Without Error Handling"
    description: "Async hook without proper error handling"
    severity: "medium"
    category: "hook-config"
    pattern: "async.*=>.*(?!\\.catch)(?!try)"
    pattern_flags: ["DOTALL"]
    recommendation: "Add error handling for async hooks"
    tags: ["hooks", "error-handling"]
    enabled: false
    false_positive_note: "Disabled: regex lookaheads constrain the wrong position; detecting unhandled async errors requires AST analysis"

  - id: "hook-timeout-disabled"
    name: "Hook Timeout Disabled"
    description: "Hook configured without timeout"
    severity: "medium"
    category: "hook-config"
    pattern: "\"timeout\"\\s*:\\s*(false|null|0)"
    pattern_flags: ["IGNORECASE"]
    recommendation: "Enable timeouts for hooks to prevent hanging"
    tags: ["hooks", "availability"]

